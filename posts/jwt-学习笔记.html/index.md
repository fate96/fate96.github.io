# JWT 学习笔记


## 前言

在实际开发过程中，rest 风格的 api 也需要访问控制，并不是任意访问就可以去往数据库里插入东西的，所以我们需要JWT来做访问控制。

## JWT 基本内容

JWT  (JSON Web Token) 是一个开放标准(RFC 7519)，它定义了一种紧凑的、自包含的方式，用于作为 JSON 对象在各方之间安全地传输信息，该信息可以被验证和信任，因为它是数字签名的。

### 使用场景

下列场景中使用JSON Web Token是很有用的。

- Authorization (授权) : 这是使用JWT的最常见场景。一旦用户登录，后续每个请求都将包含JWT，允许用户访问该令牌允许的路由、服务和资源。单点登录是现在广泛使用的JWT的一个特性，因为它的开销很小，并且可以轻松地跨域使用。
- l Information Exchange (信息交换) : 对于安全的在各方之间传输信息而言，JSON Web Tokens无疑是一种很好的方式。因为JWTs可以被签名，例如，用公钥/私钥对，你可以确定发送人就是它们所说的那个人。另外，由于签名是使用头和有效负载计算的，您还可以验证内容有没有被篡改

### 为什么需要 JWT

#### 跨域问题

当采用分布式部署 web 时，一个网站可能有不同的域名，但 cookie 是根据同源策略，故不会将 cookie 信息发送至不同网站，因此用户可能需要再次登陆，造成用户体验不好。

#### 单点登陆

使用负载均衡时，为了解决 session 问题，要么采用同一请求 ip 只映射到一台服务器，要么采用 session 复制。但这两个方案实现都不好，前者没有负载均衡，若服务器出现问题，则无服务器提供服务，后者则造成 session 冗余，内存浪费。

#### Token Vs Session

1. Session

在讨论基于Token的身份认证是如何工作的以及它的好处之前，我们先来看一下以前我们是怎么做的：（基于session的身份认证）

HTTP协议是无状态的，也就是说，如果我们已经认证了一个用户，那么他下一次请求的时候，服务器不知道我是谁，我们必须再次认证

传统的做法是将已经认证过的用户信息存储在服务器上，比如Session。用户下次请求的时候带着Session ID，然后服务器以此检查用户是否认证过。

这种基于服务器的身份认证方式存在一些问题：

- Sessions : 每次用户认证通过以后，服务器需要创建一条记录保存用户信息，通常是在内存中，随着认证通过的用户越来越多，服务器的在这里的开销就会越来越大。
- Scalability : 由于Session是在内存中的，这就带来一些扩展性的问题。
- CORS : 当我们想要扩展我们的应用，让我们的数据被多个移动设备使用时，我们必须考虑跨资源共享问题。当使用AJAX调用从另一个域名下获取资源时，我们可能会遇到禁止请求的问题。
- CSRF : 用户很容易受到CSRF攻击

2. Token

使用基于 Token 的身份验证方法，在服务端不需要存储用户的登录记录，大概流程如下

- 客户端使用用户名、密码请求登录
- 服务端收到请求、去验证用户名与密码
- 验证成功后，服务端会签发一个 token ，再把这个 token 发送给客户端
- 客户端收到 token 以后可以把它存储起来，存到客户端内存或者其他地方
- 客户端每次向服务器请求资源的时服务端收到请求，然后去验证客户端请求里面带着的 token
- 服务端收到请求，然后去验证客户端请求里面带着的 token，如果验证成功，就向客户端返回请求的数据

相同点是，它们都是存储用户信息；然而，Session是在服务器端的，而 JWT是在客户端的。Session方式存储用户信息的最大问题在于要占用大量服务器内存，增加服务器的开销，而 Token 的方式将用户状态分散到了客户端中，可以明显减轻服务端的内存压力，Session的状态是存储在服务器端，客户端只有session id，而 Token 的状态是存储在客户端。

#### Token 的好处

- 无状态和可扩展性： Token 存储在客户端，完全无状态，可扩展，我们的负载均衡器可以将用户传递到任意服务器上，因为任何服务器都不没状态信息或会话信息
- 安全：Token 不是 cookie，每次请求的时候 Token 都会被发送。而 且由于 cookie 没有发送，有助于 CSRF 攻击，即使实现中将 token 存储到 cookie 当中，这个 cookie 也是一种存储机制，而非身份认证机制。

#### JWT Token 基本格式

JSON Web Token由三部分组成，它们之间用圆点(.)连接。这三部分分别是：

- Header
- Payload
- Signature

