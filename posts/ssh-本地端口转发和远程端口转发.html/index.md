# SSH 本地端口转发和远程端口转发


## 前言

由于课题组的服务器处于校园网内网，正常情况外网是无法通过 ssh 连接，常用解决方法有如下几种：

1. 通过向日葵等远程软件：利用远程桌面访问校园网
2. frp 等内网穿透工具：将内网服务器的端口暴露至外网服务器，通过公网服务器访问
3. ssh 端口转发：通过 ssh 远程端口转发，建立内网与外网的 ssh 连接。

其中 ssh 端口转发相比内网穿透更为简单，而远程桌面通常太卡使用上不如终端体验。

## ssh 两种端口转发模式

两种转发模式都是利用跳板机进行 ssh 连接

### 本地端口转发

本地端口转发主要用在同一个网络的情况下。比如 host1 与 host2 不能直接连接，但是 host3 可以与 host1 和 host2 连接，因此 host3 可以作为跳板机将 host1 与 host2 连接起来，在 host1 使用如下指令既可以连接至 host2

```bash
ssh -L localport:host2:targetport host3
```

localport 指的是本地服务器的端口，而 targetport 指的是目的服务器的端口。

具体如下：

```bash
ssh -L 2233:10.51.19.11:22 username@hostname
```

上述指令是通过 `username@hostname` 跳板机，从本地端口 `2233` 连接至远程服务器  `10.51.19.11:22` 。**因此该情况需要外部机器可以 ssh 连接至跳板机**

### 远程端口转发

外部端口转发实现步骤，是先将内网的端口与外网端口进行绑定，此时外网直接访问对应端口即可以访问至内网。在跳板机上 host2 输入如下指令

```bash
ssh -R host1port:host2:22 host1
```

上述指令将跳板机 host2 端口 `22` 绑定至外网端口 `host1port` ，此时则可以在 host1 机器则可以通过对应端口直接访问跳板机 host2

具体指令如下：

```bash
ssh -R 2233:localhost:22 ubuntu@1234.1234.1234.1234
```

上述指令将跳板机端口 22 绑定至服务器 `ubuntu@1234.1234.1234.1234` 端口，并建立了 ssh 连接。此时服务器可以通过访问本地 `2233` 端口访问至跳板机上。

```bash
## 远程服务器
ssh -p 2233 ubuntu@localhost
```

因为服务器与跳板机需要维持 ssh 连接，因此这两台机器上必须都要有 `ssh` 和 `sshd` 。

### ssh 其他参数

N参数，表示只连接远程主机，不打开远程shell；T参数，表示不为这个连接分配TTY。这个两个参数可以放在一起用，代表这个SSH连接只用来传数据，不执行远程操作。

f参数，表示SSH连接成功后，转入后台运行。这样一来，你就可以在不中断SSH连接的情况下，在本地shell中执行其他操作。

## 校园网连接方式

处于校园网的内部网络中，外部机器是无法 ssh 连接至校园网的内部机器，因此本地端口转发无法实现该需求，需通过远程端口转发实现。

首先在跳板机上输入指令，将跳板机端口绑定至外网机器。

```bash
ssh -fNTR 2233:localhost:22 ubuntu@39.108.XXX.XXX
```

接着 ssh 连接至外部服务器，在外部服务器输入指令，连接至跳板机。username 不是服务器的用户名，而是跳板机的用户名。

```bash
ssh -p 2233 username@localhost
```

此时即在外网服务器已经连接上了跳板机。后续可以通过跳板机再连接至课题组的目标服务器。

当然，也可以将课题组的服务器将端口绑定至外网服务器，即忽略跳板机的存在，直接连接至课题组的服务器。

## 参考资料

[SSH原理与运用（二）：远程操作与端口转发](https://www.ruanyifeng.com/blog/2011/12/ssh_port_forwarding.html)

[彻底搞懂SSH端口转发命令](彻底搞懂SSH端口转发命令) 

[SSH 端口转发](https://wangdoc.com/ssh/port-forwarding.html#:~:text=%E8%BF%9C%E7%A8%8B%E8%BD%AC%E5%8F%91%E6%8C%87%E7%9A%84%E6%98%AF,%E8%BF%9C%E7%A8%8B%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%AE%BF%E9%97%AE%E6%9C%AC%E5%9C%B0%E8%AE%A1%E7%AE%97%E6%9C%BA%E3%80%82)

[SSH 端口转发简明教程](https://sspai.com/post/61641)

 

